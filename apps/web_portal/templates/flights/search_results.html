<div id="content-search">
  <div class="results-toolbar">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div class="d-flex flex-wrap align-items-center gap-2">
        <div class="results-title">Results</div>
        {% if results is defined %}
          <span class="chip muted">{{ results|length }} options</span>
        {% endif %}
      </div>

          <div class="d-flex align-items-center gap-2">
            {% if hide_search %}
              <div class="d-flex align-items-center gap-2">
                {% if defaults.trip_type != 'roundtrip' %}
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="prevDayBtn">Previous day</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="nextDayBtn">Next day</button>
                {% endif %}
                <button type="button" class="btn btn-outline-secondary btn-sm" id="toggleBaggageBtn">With baggage</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="showSearchBtn">Back to search</button>
              </div>
            {% endif %}
            <span class="small text-muted">Sort</span>
            <select class="form-select form-select-sm" style="width: 175px;" data-sort>
          <option value="best" selected>Best</option>
          <option value="cheapest">Cheapest</option>
          <option value="fastest">Fastest</option>
          <option value="fewest_stops">Fewest stops</option>
        </select>
      </div>
    </div>
  </div>

{% if results is not defined %}
    <div class="empty mt-3">
      <div class="fw-semibold">Search to see flights.</div>
      <div class="text-muted small">Results will appear here in a Google Flights-style list.</div>
    </div>
  {% elif results|length == 0 %}
    <div class="empty mt-3">
      <div class="fw-semibold">No results.</div>
      <div class="text-muted small">Try another date or route.</div>
    </div>
  {% else %}

    <div class="mt-3" data-results>
      <div class="section-head mb-2">
        <div class="fw-semibold">Departure flights{% if depart_label_date %} {{ depart_label_date }}{% endif %}</div>
        {% if hide_search and defaults.trip_type == 'roundtrip' %}
          <div class="head-actions d-flex align-items-center gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="prevDayDepart">Previous day</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="nextDayDepart">Next day</button>
          </div>
        {% endif %}
      </div>
      <div class="vstack gap-3" id="departResults">
        {% for r in results %}
          <div class="result-row gf-result"
               data-item data-leg="outbound"
               data-airline="{{ r.segments[0].airline }}"
               data-has-bag="{{ '1' if r.get('_has_bag') else '0' }}"
               data-price="{{ r.amount_raw }}"
               data-duration="{{ r.summary.duration_mins or 999999 }}"
               data-stops="{{ r.summary.stops }}">
            {% set first = r.segments[0] %}
            {% set last = r.segments[-1] %}
            {% set ticketing = r.get("ticketing", {}) %}
            {% set airline_display = first.airline_name or ticketing.get("companyShortName") or first.airline %}

            <div class="gf-head" role="button" tabindex="0"
                    data-bs-toggle="collapse" data-bs-target="#d{{ r.sequenceNumber }}"
                    aria-expanded="false" aria-controls="d{{ r.sequenceNumber }}">
              <div class="gf-logo">
                <div class="airlogo" aria-hidden="true">{{ first.airline }}</div>
              </div>

              <div class="gf-times">
                <div class="gf-main">{{ r.summary.depart_time }} – {{ r.summary.arrive_time }}</div>
                <div class="gf-sub">{{ airline_display }}</div>
              </div>

              <div class="gf-duration">
                <div class="gf-main">{{ r.summary.duration }}</div>
                <div class="gf-sub">{{ first.dep }}–{{ last.arr }}</div>
              </div>

              <div class="gf-seats">
                <div class="gf-main">Seats</div>
                <div class="gf-sub" data-seats-value data-flight-key="{{ r.get('_flight_key', '') }}">{{ r.get('_seats_available', '…') }}</div>
              </div>

              <div class="gf-stops">
                <div class="gf-main">{{ r.summary.stops_label }}</div>
                <div class="gf-sub">&nbsp;</div>
              </div>

              {% set has_bag = r.get('_has_bag', false) %}

              <div class="gf-price">
                <button type="button" class="gf-select" data-leg="outbound"
                        data-collapse="#d{{ r.sequenceNumber }}"
                        data-itinerary='{{ r | tojson }}'>Select flight</button>
                <div class="gf-amt">
                  {% if not has_bag %}
                    <span class="no-bag" title="No baggage included" aria-label="No baggage included">
                      <img src="/assets/no_baggage.svg" alt="" aria-hidden="true" />
                    </span>
                  {% endif %}
                  <span class="gf-ccy">{{ r.total_currency }}</span> <span class="gf-amount" data-display-total>{{ r.total_amount }}</span>
                </div>
              </div>

              <div class="gf-chev" aria-hidden="true">
                <svg class="chev" viewBox="0 0 24 24" fill="none">
                  <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </div>

            <div class="collapse" id="d{{ r.sequenceNumber }}">
              <div class="row-body">
                <div class="itin">
                  {% for s in r.segments %}
                    {% if s._layover %}
                      <div class="itin-layover">{{ s._layover }}</div>
                    {% endif %}

                    <div class="itin-row">
                      <div class="itin-mark">
                        <div class="itin-dot"></div>
                        <div class="itin-vline"></div>
                      </div>
                      <div class="itin-text">
                        <div class="itin-title"><span class="itin-time">{{ s._dep_time }}</span> · {{ s.dep }}</div>
                      </div>
                    </div>

                    <div class="itin-row itin-mid">
                      <div class="itin-mark">
                        <div class="itin-gap"></div>
                        <div class="itin-vline dotted"></div>
                      </div>
                      <div class="itin-text">
                        <div class="itin-meta">Travel time:{% if s.duration %} {{ s.duration }}{% endif %}</div>
                      </div>
                    </div>

                    <div class="itin-row">
                      <div class="itin-mark">
                        <div class="itin-dot"></div>
                        <div class="itin-vline"></div>
                      </div>
                      <div class="itin-text">
                        <div class="itin-title"><span class="itin-time">{{ s._arr_time }}</span> · {{ s.arr }}</div>
                      </div>
                    </div>

                    <div class="itin-foot">
                      {{ airline_display }} · {{ r._cabin or (defaults.cabin|capitalize) }}
                      {% if s.aircraft %} · {{ s.aircraft }}{% endif %}
                      · {{ s.airline }} {{ s.flight }}
                      {% if s.baggage %} · Baggage {{ s.baggage }}{% endif %}
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

{% if results|length > 15 %}
  <div class="mt-3 d-flex justify-content-center">
    <button type="button"
            class="btn btn-outline-secondary btn-sm"
            id="departLoadMore">
      Load more
    </button>
  </div>
{% endif %}


      {% if results_return and defaults.trip_type == 'roundtrip' %}
        <div class="mt-4" id="returnSection">
          <div class="section-head mb-2">
            <div class="fw-semibold">Return flights{% if return_label_date %} {{ return_label_date }}{% endif %}</div>
            {% if hide_search and defaults.trip_type == 'roundtrip' %}
              <div class="head-actions d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="prevDayReturn">Previous day</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="nextDayReturn">Next day</button>
              </div>
            {% endif %}
          </div>
          <div class="vstack gap-3" id="returnResults">
            {% for r in results_return %}
              <div class="result-row gf-result"
                   data-item data-leg="return"
                   data-airline="{{ r.segments[0].airline }}"
                   data-has-bag="{{ '1' if r.get('_has_bag') else '0' }}"
                   data-price="{{ r.amount_raw }}"
                   data-duration="{{ r.summary.duration_mins or 999999 }}"
                   data-stops="{{ r.summary.stops }}">
                {% set first = r.segments[0] %}
                {% set last = r.segments[-1] %}
                {% set ticketing = r.get("ticketing", {}) %}
                {% set airline_display = first.airline_name or ticketing.get("companyShortName") or first.airline %}

                <div class="gf-head" role="button" tabindex="0"
                    data-bs-toggle="collapse" data-bs-target="#rd{{ r.sequenceNumber }}"
                    aria-expanded="false" aria-controls="rd{{ r.sequenceNumber }}">
                  <div class="gf-logo">
                    <div class="airlogo" aria-hidden="true">{{ first.airline }}</div>
                  </div>

                  <div class="gf-times">
                    <div class="gf-main">{{ r.summary.depart_time }} – {{ r.summary.arrive_time }}</div>
                    <div class="gf-sub">{{ airline_display }}</div>
                  </div>

                  <div class="gf-duration">
                    <div class="gf-main">{{ r.summary.duration }}</div>
                    <div class="gf-sub">{{ first.dep }}–{{ last.arr }}</div>
                  </div>

                  <div class="gf-seats">
                    <div class="gf-main">Seats</div>
                    <div class="gf-sub" data-seats-value data-flight-key="{{ r.get('_flight_key', '') }}">{{ r.get('_seats_available', '…') }}</div>
                  </div>

                  <div class="gf-stops">
                    <div class="gf-main">{{ r.summary.stops_label }}</div>
                    <div class="gf-sub">&nbsp;</div>
                  </div>

                  {% set has_bag = r.get('_has_bag', false) %}

                  <div class="gf-price">
                    <button type="button" class="gf-select" data-leg="return"
                            data-collapse="#rd{{ r.sequenceNumber }}"
                            data-itinerary='{{ r | tojson }}'>Select flight</button>
                    <div class="gf-amt">
                      {% if not has_bag %}
                        <span class="no-bag" title="No baggage included" aria-label="No baggage included">
                          <img src="/assets/no_baggage.svg" alt="" aria-hidden="true" />
                        </span>
                      {% endif %}
                      <span class="gf-ccy">{{ r.total_currency }}</span> <span class="gf-amount" data-display-total>{{ r.total_amount }}</span>
                    </div>
                  </div>

                  <div class="gf-chev" aria-hidden="true">
                    <svg class="chev" viewBox="0 0 24 24" fill="none">
                      <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                </div>

            <div class="collapse" id="rd{{ r.sequenceNumber }}">
                  <div class="row-body">
                    <div class="itin">
                      {% for s in r.segments %}
                        {% if s._layover %}
                          <div class="itin-layover">{{ s._layover }}</div>
                        {% endif %}

                        <div class="itin-row">
                          <div class="itin-mark">
                            <div class="itin-dot"></div>
                            <div class="itin-vline"></div>
                          </div>
                          <div class="itin-text">
                            <div class="itin-title"><span class="itin-time">{{ s._dep_time }}</span> · {{ s.dep }}</div>
                          </div>
                        </div>

                        <div class="itin-row itin-mid">
                          <div class="itin-mark">
                            <div class="itin-gap"></div>
                            <div class="itin-vline dotted"></div>
                          </div>
                          <div class="itin-text">
                            <div class="itin-meta">Travel time:{% if s.duration %} {{ s.duration }}{% endif %}</div>
                          </div>
                        </div>

                        <div class="itin-row">
                          <div class="itin-mark">
                            <div class="itin-dot"></div>
                            <div class="itin-vline"></div>
                          </div>
                          <div class="itin-text">
                            <div class="itin-title"><span class="itin-time">{{ s._arr_time }}</span> · {{ s.arr }}</div>
                          </div>
                        </div>

                        <div class="itin-foot">
                          {{ airline_display }} · {{ r._cabin or (defaults.cabin|capitalize) }}
                          {% if s.aircraft %} · {{ s.aircraft }}{% endif %}
                          · {{ s.airline }} {{ s.flight }}
                          {% if s.baggage %} · Baggage {{ s.baggage }}{% endif %}
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

{% if results_return|length > 15 %}
  <div class="mt-3 d-flex justify-content-center">
    <button type="button"
            class="btn btn-outline-secondary btn-sm"
            id="returnLoadMore">
      Load more
    </button>
  </div>
{% endif %}

        </div>
      {% endif %}
      <!-- Selection footer (shown only after selection) -->
      <div class="selection-footer card mt-4 d-none" id="selectionFooter">
        <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div class="d-flex align-items-baseline gap-2">
            <div class="fw-semibold">Total price</div>
            <div class="mono" id="selectionTotal">—</div>
          </div>
          <div class="d-flex flex-wrap align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleBreakdown">
              Details
              <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button type="button" class="btn btn-primary" id="continueBtn">Continue</button>
          </div>
        </div>
            <div class="selection-breakdown d-none" id="selectionBreakdown">
              <div class="selection-breakdown-inner">
                <div class="bd-title">Price breakdown</div>
                <div class="bd-row"><span>Fare</span><span id="selectionFare">—</span></div>
                <div class="bd-row"><span>Tax</span><span id="selectionTax">—</span></div>
                <div class="bd-row"><span>Commission</span><span id="selectionCommission">—</span></div>
                <div class="bd-total"><span>Total (after adjustments)</span><span id="selectionTotalAdjusted">—</span></div>
              </div>
            </div>
      </div>
    </div>
  </div>
</div>

<style>
  .lm-hidden { display: none !important; }
</style>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const INITIAL_COUNT = 15;
    const STEP = 5;

    function setupLoadMore(containerId, buttonId) {
      const container = document.getElementById(containerId);
      const btn = document.getElementById(buttonId);
      if (!container || !btn) return;

      const items = Array.from(container.querySelectorAll(".gf-result"));
      if (!items.length) {
        btn.classList.add("d-none");
        return;
      }

      // Hide everything beyond the first 15
      items.forEach((el, idx) => {
        if (idx >= INITIAL_COUNT) el.classList.add("lm-hidden");
      });

      function refreshButton() {
        const remaining = items.filter(el => el.classList.contains("lm-hidden")).length;
        if (remaining <= 0) btn.classList.add("d-none");
        else btn.classList.remove("d-none");
      }

      btn.addEventListener("click", () => {
        let revealed = 0;
        for (const el of items) {
          if (el.classList.contains("lm-hidden")) {
            el.classList.remove("lm-hidden");
            revealed += 1;
            if (revealed >= STEP) break;
          }
        }
        refreshButton();
      });

      refreshButton();
    }

    setupLoadMore("departResults", "departLoadMore");
    setupLoadMore("returnResults", "returnLoadMore");
  });
</script>

  {% endif %}
</div>
