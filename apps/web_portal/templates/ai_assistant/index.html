{% extends "base.html" %}

{% block content %}
<div class="container app-shell py-4">
  <div class="card search-card ai-assistant-card">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-3">
        <div>
          <h4 class="mb-1">AI Assistant</h4>
          <div class="text-muted small">Travel info and operations help, available as a paid add-on.</div>
        </div>
        <span class="badge text-bg-light border">Add-on</span>
      </div>

      {% if not has_ai_assistant %}
        <div class="alert alert-warning d-flex flex-column gap-2">
          <div class="fw-semibold">AI Assistant add-on required</div>
          <div class="small">Purchase the add-on to enable AI assistance for your account.</div>
          <div>
            <a class="btn btn-sm btn-primary" href="{{ request.url_for('subscriptions') }}">Go to Subscriptions</a>
          </div>
        </div>
      {% else %}
        {% if not ai_api_ready %}
          <div class="alert alert-danger d-flex flex-column gap-2">
            <div class="fw-semibold">AI service is not configured</div>
            <div class="small">Set the <code>OPENAI_API_KEY</code> environment variable on the server to enable this add-on.</div>
          </div>
        {% endif %}
        <div class="ai-assistant-shell">
          <div class="ai-assistant-toolbar">
            <div class="btn-group ai-mode-toggle" role="group" aria-label="Assistant mode">
              <button type="button" class="btn btn-outline-primary active" data-mode="travel">Travel info</button>
              <button type="button" class="btn btn-outline-primary" data-mode="ops">Operations</button>
            </div>
            <div class="ai-quick-actions">
              <button class="btn btn-sm btn-outline-dark" type="button" data-suggest="What is the IATA code for Baghdad airport?">Airport code</button>
              <button class="btn btn-sm btn-outline-dark" type="button" data-suggest="Explain the baggage rules for economy flights.">Baggage rules</button>
              <button class="btn btn-sm btn-outline-dark" type="button" data-suggest="How do I add a visa application for a family?">Platform help</button>
            </div>
            <button class="btn btn-sm btn-outline-secondary" type="button" id="aiClearBtn">Clear</button>
          </div>

          <div class="ai-assistant-body" id="aiMessages" aria-live="polite"></div>

          <form class="ai-assistant-input" id="aiForm">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="aiInput"
                placeholder="Ask about airport codes, visas, routes, or how to use the platform…"
                autocomplete="off"
              >
              <button class="btn btn-primary" type="submit" id="aiSendBtn">Send</button>
            </div>
            <div class="small text-muted mt-2">Responses are generated by AI and may be inaccurate. Verify critical details.</div>
          </form>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% if has_ai_assistant %}
  <script>
    (function () {
      const messagesEl = document.getElementById('aiMessages');
      const formEl = document.getElementById('aiForm');
      const inputEl = document.getElementById('aiInput');
      const sendBtn = document.getElementById('aiSendBtn');
      const clearBtn = document.getElementById('aiClearBtn');
      const modeButtons = document.querySelectorAll('.ai-mode-toggle .btn');
      const suggestButtons = document.querySelectorAll('[data-suggest]');

      let mode = 'travel';

      function setMode(next) {
        mode = next;
        modeButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.mode === mode);
        });
      }

      function addMessage(role, text, save = true) {
        const wrapper = document.createElement('div');
        wrapper.className = `ai-message ai-${role}`;
        wrapper.innerHTML = `<div class=\"ai-bubble\">${escapeHtml(text)}</div>`;
        messagesEl.appendChild(wrapper);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        if (save) {
          saveHistory(role, text);
        }
      }

      function addStatus(text) {
        const wrapper = document.createElement('div');
        wrapper.className = 'ai-message ai-status';
        wrapper.innerHTML = `<div class=\"ai-bubble\">${escapeHtml(text)}</div>`;
        messagesEl.appendChild(wrapper);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return wrapper;
      }

      function escapeHtml(str) {
        return String(str || '').replace(/[&<>\"]/g, (c) => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;'
        }[c]));
      }

      function loadHistory() {
        try {
          const raw = sessionStorage.getItem('ai_history');
          const data = raw ? JSON.parse(raw) : [];
          return Array.isArray(data) ? data : [];
        } catch (err) {
          return [];
        }
      }

      function saveHistory(role, content) {
        const history = loadHistory();
        history.push({ role, content });
        // keep last 12 messages
        while (history.length > 12) history.shift();
        sessionStorage.setItem('ai_history', JSON.stringify(history));
      }

      function clearHistory() {
        sessionStorage.removeItem('ai_history');
      }

      async function sendMessage() {
        const text = (inputEl.value || '').trim();
        if (!text) return;
        inputEl.value = '';
        addMessage('user', text);
        const statusNode = addStatus('Thinking…');
        sendBtn.disabled = true;
        inputEl.disabled = true;

        try {
          const history = loadHistory();
          const resp = await fetch('/assistant/api/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, mode, history })
          });
          const data = await resp.json();
          statusNode.remove();
          if (!resp.ok || data.status !== 'ok') {
            addMessage('assistant', data.error || 'Something went wrong.');
          } else {
            addMessage('assistant', data.reply || 'No response.');
          }
        } catch (err) {
          statusNode.remove();
          addMessage('assistant', 'Network error. Please try again.');
        } finally {
          sendBtn.disabled = false;
          inputEl.disabled = false;
          inputEl.focus();
        }
      }

      formEl.addEventListener('submit', (e) => {
        e.preventDefault();
        sendMessage();
      });

      clearBtn.addEventListener('click', () => {
        messagesEl.innerHTML = '';
        clearHistory();
      });

      modeButtons.forEach(btn => {
        btn.addEventListener('click', () => setMode(btn.dataset.mode));
      });

      suggestButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          inputEl.value = btn.dataset.suggest || '';
          inputEl.focus();
        });
      });

      const history = loadHistory();
      if (history.length) {
        history.forEach((msg) => {
          addMessage(msg.role, msg.content, false);
        });
      } else {
        addMessage('assistant', 'Hi! Ask me for airport codes, travel info, or how to use the platform.');
      }
    })();
  </script>
{% endif %}
{% endblock %}
