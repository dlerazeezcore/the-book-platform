{% extends "base.html" %}

{% block content %}
<div class="container app-shell py-4">
  <div class="card search-card">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="h5 mb-1">User actions</div>
          <div class="text-muted small">Manage API access, balances, and profile details.</div>
        </div>
        <a class="btn btn-sm btn-outline-secondary" href="{{ request.url_for('admin_users') }}">Back</a>
      </div>

      <hr class="my-3"/>

      {% if not u %}
        <div class="alert alert-warning">User not found.</div>
      {% else %}
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>
            <div class="fw-semibold">{{ u.company_name }} — {{ u.username }}</div>
            <div class="text-muted small">Email: {{ u.email or '-' }} · Phone: {{ u.phone or '-' }} · Preferred payment: {{ u.preferred_payment }}</div>
          </div>
          <div class="d-flex gap-2">
            <form method="post" action="{{ request.url_for('admin_user_toggle', user_id=u.id) }}">
              {% if u.active %}
                <button class="btn btn-sm btn-outline-danger" type="submit">Deactivate</button>
              {% else %}
                <button class="btn btn-sm btn-outline-success" type="submit">Activate</button>
              {% endif %}
            </form>
            <form method="post" action="{{ request.url_for('admin_user_delete', user_id=u.id) }}" onsubmit="return confirm('Delete this company and all its sub users?');">
              <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
            </form>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <div class="fw-semibold">Balances</div>
                <div class="d-flex gap-3 mt-2">
                  <div>
                    <div class="text-muted small">Credit</div>
                    <div class="h6 mb-0">{{ u.credit }}</div>
                  </div>
                  <div>
                    <div class="text-muted small">Cash</div>
                    <div class="h6 mb-0">{{ u.cash }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <div class="fw-semibold">Status</div>
                <div class="mt-2">
                  {% if u.active %}
                    <span class="badge text-bg-success">Active</span>
                  {% else %}
                    <span class="badge text-bg-secondary">Blocked</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <ul class="nav nav-tabs mt-4" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabApis" type="button" role="tab">API access</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabBalance" type="button" role="tab">Change balance</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabCommission" type="button" role="tab">Commission</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMarkup" type="button" role="tab">Markup</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabProfile" type="button" role="tab">Edit profile</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabEmployees" type="button" role="tab">Company users</button>
          </li>
        </ul>

        <div class="tab-content border border-top-0 rounded-bottom p-3">
          <div class="tab-pane fade show active" id="tabApis" role="tabpanel">
            <div class="fw-semibold">Enable/disable provider access for this company</div>
            <div class="text-muted small">If disabled, the company will not see or use that provider.</div>
            <div class="mt-3">
              {% for p in providers %}
                <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
                  <div>
                    <div class="fw-semibold">{{ p.name }}</div>
                    <div class="text-muted small">{{ p.id }}</div>
                  </div>
                  <form method="post" action="{{ request.url_for('admin_user_api', user_id=u.id) }}">
                    <input type="hidden" name="provider_id" value="{{ p.id }}" />
                    {% set allowed = (u.apis or []) %}
                    {% if (p.id|lower) in allowed %}
                      <button class="btn btn-sm btn-outline-danger" type="submit">Disable</button>
                    {% else %}
                      <button class="btn btn-sm btn-outline-success" type="submit">Enable</button>
                    {% endif %}
                  </form>
                </div>
              {% endfor %}
            </div>
          </div>

          <div class="tab-pane fade" id="tabBalance" role="tabpanel">
            <div class="fw-semibold">Change credit/cash</div>
            <div class="text-muted small">Keeps a simple audit trail in the user record.</div>
            <form class="row g-2 mt-2" method="post" action="{{ request.url_for('admin_user_balance', user_id=u.id) }}">
              <div class="col-md-2">
                <select class="form-select" name="kind">
                  <option value="credit">Credit</option>
                  <option value="cash">Cash</option>
                </select>
              </div>
              <div class="col-md-2">
                <select class="form-select" name="direction">
                  <option value="increase">Increase</option>
                  <option value="decrease">Decrease</option>
                </select>
              </div>
              <div class="col-md-2"><input class="form-control" name="amount" placeholder="Amount" required></div>
              <div class="col-md-3"><input class="form-control" name="reference" placeholder="Reference"></div>
              <div class="col-md-3"><input class="form-control" name="notes" placeholder="Notes"></div>
              <div class="col-12"><button class="btn btn-dark" type="submit">Save</button></div>
            </form>
          </div>

          <div class="tab-pane fade" id="tabCommission" role="tabpanel">
            <div class="fw-semibold">Commission (Flights)</div>
            <div class="text-muted small">Set per-airline commission. Percent is applied to the fare amount; fixed is applied to the total amount.</div>

            <form class="row g-2 mt-3" method="post" action="{{ request.url_for('admin_user_commission_add', user_id=u.id) }}">
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">Airline name</label>
                <input class="form-control" name="airline_name" placeholder="Iraqi Airways">
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted mb-1">Airline code</label>
                <input class="form-control" name="airline_code" placeholder="IA" required>
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Commission type</label>
                <select class="form-select" name="rule_type">
                  <option value="percent">Percent (fare)</option>
                  <option value="fixed">Fixed (total)</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted mb-1">Amount</label>
                <input class="form-control" type="number" min="0" step="0.01" name="amount" placeholder="6 or 4" required>
              </div>
              <div class="col-md-1 d-flex align-items-end">
                <button class="btn btn-dark w-100" type="submit">Add</button>
              </div>
            </form>

            <div class="mt-3">
              <div class="fw-semibold">Existing rules</div>
              {% set ns = namespace(count=0) %}
              <div class="table-responsive mt-2">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Airline</th>
                      <th>Type</th>
                      <th>Amount</th>
                      <th>Applied on</th>
                      <th class="text-end">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for r in (u.commission or []) %}
                      {% if r.service == "flight" %}
                        {% set ns.count = ns.count + 1 %}
                        <tr>
                          <td>
                            {{ r.airline_name or "-" }}
                            <span class="text-muted small ms-1">({{ r.airline_code or "-" }})</span>
                          </td>
                          <td>{{ "Percent" if r.type == "percent" else "Fixed" }}</td>
                          <td>
                            {% if r.type == "percent" %}{{ r.amount }}%{% else %}{{ r.amount }}{% endif %}
                          </td>
                          <td>{{ "Fare" if r.type == "percent" else "Total" }}</td>
                          <td class="text-end">
                            <form method="post" action="{{ request.url_for('admin_user_commission_delete', user_id=u.id) }}" onsubmit="return confirm('Delete this commission rule?');">
                              <input type="hidden" name="rule_id" value="{{ r.id }}">
                              <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                            </form>
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                    {% if ns.count == 0 %}
                      <tr><td colspan="5" class="text-muted">No flight commission rules yet.</td></tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="tabMarkup" role="tabpanel">
            <div class="fw-semibold">Markup (Flights)</div>
            <div class="text-muted small">Set per-airline markup. Percent is applied to the fare amount; fixed is applied to the total amount.</div>

            <form class="row g-2 mt-3" method="post" action="{{ request.url_for('admin_user_markup_add', user_id=u.id) }}">
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">Airline name</label>
                <input class="form-control" name="airline_name" placeholder="Austrian Airlines">
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted mb-1">Airline code</label>
                <input class="form-control" name="airline_code" placeholder="OS" required>
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Markup type</label>
                <select class="form-select" name="rule_type">
                  <option value="percent">Percent (fare)</option>
                  <option value="fixed">Fixed (total)</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted mb-1">Amount</label>
                <input class="form-control" type="number" min="0" step="0.01" name="amount" placeholder="6 or 4" required>
              </div>
              <div class="col-md-1 d-flex align-items-end">
                <button class="btn btn-dark w-100" type="submit">Add</button>
              </div>
            </form>

            <div class="mt-3">
              <div class="fw-semibold">Existing rules</div>
              {% set ns = namespace(count=0) %}
              <div class="table-responsive mt-2">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Airline</th>
                      <th>Type</th>
                      <th>Amount</th>
                      <th>Applied on</th>
                      <th class="text-end">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for r in (u.markup or []) %}
                      {% if r.service == "flight" %}
                        {% set ns.count = ns.count + 1 %}
                        <tr>
                          <td>
                            {{ r.airline_name or "-" }}
                            <span class="text-muted small ms-1">({{ r.airline_code or "-" }})</span>
                          </td>
                          <td>{{ "Percent" if r.type == "percent" else "Fixed" }}</td>
                          <td>
                            {% if r.type == "percent" %}{{ r.amount }}%{% else %}{{ r.amount }}{% endif %}
                          </td>
                          <td>{{ "Fare" if r.type == "percent" else "Total" }}</td>
                          <td class="text-end">
                            <form method="post" action="{{ request.url_for('admin_user_markup_delete', user_id=u.id) }}" onsubmit="return confirm('Delete this markup rule?');">
                              <input type="hidden" name="rule_id" value="{{ r.id }}">
                              <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                            </form>
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                    {% if ns.count == 0 %}
                      <tr><td colspan="5" class="text-muted">No flight markup rules yet.</td></tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="tabProfile" role="tabpanel">
            <div class="fw-semibold">Edit profile</div>
            <div class="text-muted small">Update company identity and contact details.</div>

            <form class="row g-2 mt-2" method="post" action="{{ request.url_for('admin_user_update', user_id=u.id) }}">
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">Company name</label>
                <input class="form-control" name="company_name" placeholder="Company name" value="{{ u.company_name or u.company or '' }}" required>
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Username</label>
                <input class="form-control" name="username" placeholder="Username" value="{{ u.username or u.user_name or '' }}" required>
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Email</label>
                <input class="form-control" name="email" placeholder="Email" type="email" value="{{ u.email or u.mail or '' }}">
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted mb-1">Phone</label>
                <input class="form-control" name="phone" placeholder="Phone" value="{{ u.phone or u.mobile or '' }}">
              </div>

              <div class="col-md-2">
                <label class="form-label small text-muted mb-1">Status</label>
                <select class="form-select" name="active">
                  <option value="1" {% if u.active %}selected{% endif %}>Active</option>
                  <option value="0" {% if not u.active %}selected{% endif %}>Blocked</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">New password (optional)</label>
                <input class="form-control" name="new_password" placeholder="Leave blank to keep current" type="password">
              </div>

              <div class="col-12">
                <button class="btn btn-dark" type="submit">Save changes</button>
              </div>
            </form>
          </div>

          <div class="tab-pane fade" id="tabEmployees" role="tabpanel">
            <div class="fw-semibold">Company users</div>
            <div class="text-muted small">All sub users under this company.</div>

            {% if not subusers or subusers|length == 0 %}
              <div class="text-muted small mt-2">No sub users for this company yet.</div>
            {% else %}
              <div class="table-responsive mt-3">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Position</th>
                      <th>Username</th>
                      <th>Email</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for s in subusers %}
                      <tr>
                        <td>{{ (s.first_name or "") ~ " " ~ (s.last_name or "") }}</td>
                        <td>{{ s.position or "" }}</td>
                        <td>{{ s.username or "" }}</td>
                        <td>{{ s.email or "" }}</td>
                        <td>
                          {% if s.active == False %}
                            <span class="badge text-bg-secondary">Inactive</span>
                          {% else %}
                            <span class="badge text-bg-success">Active</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}

            <div class="mt-2">
              <a class="btn btn-sm btn-outline-dark" href="{{ request.url_for('admin_sub_users') }}?company={{ u.id }}">Manage in Sub Users panel</a>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
