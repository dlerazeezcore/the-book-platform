{% extends "base.html" %}

{% block content %}
<div class="esim-report">
  <div class="container app-shell py-4">
    <div class="text-center mb-4">
      <div class="report-eyebrow">Partner Portal</div>
      <h1 class="report-title">Orders</h1>
      <div class="report-subtitle">Review recent orders, trigger refresh, or export for reconciliation.</div>
    </div>

    <div class="report-card">
      <div class="report-toolbar">
        <div class="report-tabs" role="tablist">
          <button class="report-tab is-active" data-status="all" type="button">All</button>
          <button class="report-tab" data-status="completed" type="button">Completed</button>
          <button class="report-tab" data-status="failed" type="button">Failed</button>
          <button class="report-tab" data-status="revoked" type="button">Revoked</button>
        </div>
        <button class="btn btn-outline-secondary btn-sm" id="esimExportBtn" type="button">Export CSV</button>
      </div>

      <div class="report-filters">
        <div class="report-search">
          <span class="report-search-icon">ðŸ”Ž</span>
          <input class="form-control" id="esimReportSearch" placeholder="Search reference, destination, customer, agent...">
        </div>
        <div class="report-filter">
          <label class="form-label small text-muted mb-1">Agent</label>
          <select class="form-select" id="esimReportAgent">
            <option value="">All agents</option>
          </select>
        </div>
        <div class="report-filter">
          <label class="form-label small text-muted mb-1">Company</label>
          <select class="form-select" id="esimReportCompany">
            <option value="">All companies</option>
          </select>
        </div>
        <div class="report-filter">
          <button class="btn btn-outline-secondary w-100" id="esimReportClear" type="button">Clear</button>
        </div>
      </div>
    </div>

    <div class="report-table card border-0 shadow-sm mt-4">
      <div class="card-body">
        <div id="esimReportRows"></div>
        <div class="report-footer" id="esimReportFooter"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade report-order-modal" id="esimOrderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <div class="report-modal-title">Order Details</div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="esimOrderDetails"></div>
      </div>
      <div class="modal-footer report-modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
  .esim-report{
    background: radial-gradient(circle at top, #f7f2e8 0%, #f4f2ec 45%, #f1f3f4 100%);
    min-height: 100%;
  }
  .report-eyebrow{
    text-transform: uppercase;
    letter-spacing: .2em;
    font-size: .75rem;
    color: #7d806f;
    font-weight: 700;
    margin-bottom: .5rem;
  }
  .report-title{
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 800;
    margin-bottom: .35rem;
  }
  .report-subtitle{ color: var(--gf-muted); }

  .report-card{
    background: #fff;
    border: 1px solid rgba(32,33,36,.08);
    border-radius: 18px;
    padding: 1.25rem;
    box-shadow: 0 8px 24px rgba(0,0,0,.04);
  }

  .report-toolbar{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  .report-tabs{ display: flex; gap: .5rem; background: #f5f6f7; border-radius: 999px; padding: .25rem; }
  .report-tab{
    border: 0;
    background: transparent;
    padding: .4rem .9rem;
    border-radius: 999px;
    font-weight: 600;
    color: var(--gf-muted);
  }
  .report-tab.is-active{
    background: #fff;
    color: var(--gf-ink);
    box-shadow: 0 2px 10px rgba(0,0,0,.08);
  }

  .report-filters{
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
  }
  .report-search{ position: relative; }
  .report-search-icon{
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    opacity: .6;
  }
  .report-search .form-control{ padding-left: 36px; border-radius: 999px; }

  .report-table .card-body{ padding: 0; }
  .report-row{
    display: grid;
    grid-template-columns: 1.2fr 1.1fr 1.2fr 1fr 2fr .9fr 1fr;
    gap: .75rem;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid rgba(32,33,36,.08);
    align-items: center;
  }
  .report-row[data-order-key]{
    cursor: pointer;
    transition: background .2s ease, box-shadow .2s ease;
  }
  .report-row[data-order-key]:hover{
    background: #f8fafc;
  }
  .report-row.header{
    background: #f7f8f9;
    text-transform: uppercase;
    font-size: .75rem;
    letter-spacing: .08em;
    color: var(--gf-muted);
    font-weight: 700;
  }
  .report-item{
    display: flex;
    align-items: center;
    gap: .5rem;
  }
  .report-flag{
    width: 28px;
    height: 28px;
    border-radius: 999px;
    background: #f0f2f3;
    display: grid;
    place-items: center;
    font-size: 1rem;
  }
  .report-status{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: .25rem .6rem;
    border-radius: 999px;
    font-weight: 700;
    font-size: .75rem;
  }
  .report-status.completed{ background: rgba(16,136,65,.12); color: #108841; }
  .report-status.failed{ background: rgba(220,53,69,.12); color: #dc3545; }
  .report-status.revoked{ background: rgba(108,117,125,.2); color: #6c757d; }
  .report-status.processing{ background: rgba(255,193,7,.2); color: #a77a00; }

  .report-footer{
    padding: .75rem 1.25rem;
    text-align: right;
    color: var(--gf-muted);
  }

  @media (max-width: 1100px){
    .report-filters{ grid-template-columns: 1fr 1fr; }
    .report-row{ grid-template-columns: 1.2fr 1fr 1fr 1fr; }
    .report-row > div:nth-child(5),
    .report-row > div:nth-child(6),
    .report-row > div:nth-child(7){ display:none; }
  }
  @media (max-width: 700px){
    .report-row{ grid-template-columns: 1.3fr 1fr; }
    .report-row > div:nth-child(3),
    .report-row > div:nth-child(4){ display:none; }
  }

  .report-order-modal .modal-dialog{
    max-width: 1000px;
    margin-top: 3.5rem;
  }
  .report-order-modal .modal-content{
    border-radius: 24px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 28px 70px rgba(15, 23, 42, 0.18);
  }
  .report-order-modal .modal-header{
    border-bottom: 1px solid #e5e7eb;
    padding: 1.25rem 1.75rem;
  }
  .report-modal-title{
    font-size: 1.4rem;
    font-weight: 700;
  }
  .report-order-modal .modal-body{
    padding: 1.5rem 1.75rem 2rem;
  }
  .report-order-modal .modal-footer{
    border-top: 1px solid #e5e7eb;
    padding: 1rem 1.75rem;
  }
  .order-detail-header{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }
  .order-detail-title{
    display: flex;
    align-items: center;
    gap: .75rem;
    font-size: 1.2rem;
    font-weight: 700;
  }
  .order-detail-price{
    font-size: 1.3rem;
    font-weight: 800;
  }
  .order-detail-card{
    border: 1px solid #e5e7eb;
    border-radius: 18px;
    padding: 1rem 1.1rem;
    background: #fbfbfb;
  }
  .order-detail-card .label{
    font-size: .75rem;
    letter-spacing: .12em;
    text-transform: uppercase;
    color: #6b7280;
    font-weight: 700;
    margin-bottom: .35rem;
  }
  .order-detail-card .value{
    font-weight: 600;
  }
  .order-detail-grid{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  .order-actions{
    display: flex;
    gap: .75rem;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 1.5rem;
  }
  .order-actions .btn{
    border-radius: 999px;
    padding: .55rem 1.4rem;
  }
  .order-actions .btn-success{
    background: #25d366;
    border-color: #25d366;
  }
  @media (max-width: 768px){
    .order-detail-grid{
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const rowsEl = document.getElementById("esimReportRows");
    const footerEl = document.getElementById("esimReportFooter");
    const searchEl = document.getElementById("esimReportSearch");
    const agentEl = document.getElementById("esimReportAgent");
    const companyEl = document.getElementById("esimReportCompany");
    const clearBtn = document.getElementById("esimReportClear");
    const exportBtn = document.getElementById("esimExportBtn");
    const tabBtns = document.querySelectorAll(".report-tab");
    const orderModalEl = document.getElementById("esimOrderModal");
    const orderDetailsEl = document.getElementById("esimOrderDetails");
    const orderModal = orderModalEl && window.bootstrap ? window.bootstrap.Modal.getOrCreateInstance(orderModalEl) : null;

    let orders = [];
    let statusFilter = "all";
    let orderLookup = new Map();

    const fmtDate = (iso) => {
      try {
        const dt = new Date(iso);
        if (Number.isNaN(dt.getTime())) return iso || "â€”";
        return dt.toLocaleString("en-US", {
          year: "numeric",
          month: "numeric",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        });
      } catch {
        return iso || "â€”";
      }
    };

    const fmtMoney = (minor) => {
      if (minor === null || minor === undefined) return "â€”";
      const n = Number(minor);
      if (!Number.isFinite(n)) return String(minor);
      return `IQD ${n.toLocaleString("en-US")}`;
    };

    const toFlag = (iso) => {
      try {
        if (!iso || iso.length !== 2) return iso || "";
        const code = iso.toUpperCase();
        const A = 0x1F1E6;
        return [...code].map(c => String.fromCodePoint(A + (c.charCodeAt(0) - 65))).join("");
      } catch {
        return iso || "";
      }
    };

    const escapeHtml = (s) => String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");

    const getReference = (o) => o.order_reference || o.reference || o.id || "";
    const getCustomerPhone = (o) => o.customer_phone || o.phone || "";
    const getActivationCodes = (o) => {
      const out = [];
      if (o.activation_code) out.push(o.activation_code);
      if (o.lpa) out.push(o.lpa);
      if (Array.isArray(o.activation_codes)) out.push(...o.activation_codes);
      if (typeof o.activation_codes === "string") out.push(o.activation_codes);
      return out.filter(Boolean);
    };
    const getIccids = (o) => {
      const out = [];
      if (o.iccid) out.push(o.iccid);
      if (Array.isArray(o.iccids)) out.push(...o.iccids);
      if (typeof o.iccids === "string") out.push(o.iccids);
      return out.filter(Boolean);
    };
    const copyText = async (text) => {
      try {
        await navigator.clipboard.writeText(text);
      } catch {
        const input = document.createElement("input");
        input.value = text;
        document.body.appendChild(input);
        input.select();
        document.execCommand("copy");
        input.remove();
      }
    };

    const applyFilters = () => {
      const q = (searchEl?.value || "").toLowerCase().trim();
      const agent = agentEl?.value || "";
      const company = companyEl?.value || "";

      return orders.filter((o) => {
        if (statusFilter !== "all" && String(o.status || "").toLowerCase() !== statusFilter) return false;
        if (agent && String(o.agent_name || "") !== agent) return false;
        if (company && String(o.company_name || "") !== company) return false;
        if (!q) return true;
        const hay = [
          o.order_reference,
          o.customer_name,
          o.agent_name,
          o.company_name,
          o.bundle_description,
          o.bundle_name,
          o.country_name,
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    };

    const renderRows = () => {
      if (!rowsEl) return;
      const list = applyFilters();
      if (!list.length) {
        rowsEl.innerHTML = '<div class="p-4 text-muted">No orders found.</div>';
        if (footerEl) footerEl.textContent = "";
        return;
      }

      let html = `
        <div class="report-row header">
          <div>Date</div>
          <div>Customer</div>
          <div>Company</div>
          <div>Agent</div>
          <div>Item</div>
          <div>Total price</div>
          <div>Status</div>
        </div>
      `;
      orderLookup = new Map();
      list.forEach((o, idx) => {
        const status = String(o.status || "processing").toLowerCase();
        const itemName = o.bundle_description || o.bundle_name || "eSIM";
        const key = getReference(o) || `row_${idx}`;
        orderLookup.set(key, o);
        html += `
          <div class="report-row" data-order-key="${escapeHtml(key)}">
            <div>${escapeHtml(fmtDate(o.created_at))}</div>
            <div>${escapeHtml(o.customer_name || "â€”")}</div>
            <div>${escapeHtml(o.company_name || "â€”")}</div>
            <div>${escapeHtml(o.agent_name || "â€”")}</div>
            <div class="report-item">
              <span class="report-flag">${escapeHtml(toFlag(o.country_iso))}</span>
              <div>
                <div class="fw-semibold">${escapeHtml(itemName)}</div>
                <div class="text-muted small">${escapeHtml(o.country_name || "")}</div>
              </div>
            </div>
            <div class="fw-semibold">${escapeHtml(fmtMoney(o.total_iqd))}</div>
            <div><span class="report-status ${status}">${escapeHtml(status)}</span></div>
          </div>
        `;
      });
      rowsEl.innerHTML = html;
      if (footerEl) footerEl.textContent = `Showing ${list.length} of ${orders.length}`;
    };

    const renderOrderDetails = (o) => {
      if (!orderDetailsEl) return;
      if (!o) {
        orderDetailsEl.innerHTML = '<div class="text-muted">Order not found.</div>';
        return;
      }
      const itemName = o.bundle_description || o.bundle_name || "eSIM";
      const ref = getReference(o);
      const customer = o.customer_name || "â€”";
      const phone = getCustomerPhone(o);
      const servedBy = o.agent_email || o.agent_name || "";
      const actCodes = getActivationCodes(o);
      const iccids = getIccids(o);
      const qrText = o.qr_code || o.qr || "";
      const qrSource = actCodes.length ? actCodes[0] : (qrText || "");
      const qrUrl = qrSource ? `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(qrSource)}` : "";
      const qrStatus = qrSource ? "" : "QR asset pending supplier confirmation.";
      const whatsappMsg = [
        `Order: ${itemName}`,
        ref ? `Reference: ${ref}` : "",
        customer ? `Customer: ${customer}` : "",
        phone ? `Phone: ${phone}` : "",
        o.country_name ? `Country: ${o.country_name}` : "",
        `Total: ${fmtMoney(o.total_iqd)}`,
        actCodes.length ? `Activation: ${actCodes[0]}` : "",
        iccids.length ? `ICCID: ${iccids[0]}` : "",
        qrUrl ? `QR: ${qrUrl}` : "",
      ].filter(Boolean).join("\n");
      orderDetailsEl.innerHTML = `
        <div class="order-detail-header mb-3">
          <div class="order-detail-title">
            <span class="report-flag">${escapeHtml(toFlag(o.country_iso))}</span>
            <span>${escapeHtml(itemName)}</span>
          </div>
          <div class="order-detail-price">${escapeHtml(fmtMoney(o.total_iqd))}</div>
        </div>

        <div class="order-detail-card mb-3">
          <div class="label">Reference</div>
          <div class="d-flex align-items-center justify-content-between gap-2">
            <div class="value">${escapeHtml(ref || "â€”")}</div>
            ${ref ? `<button class="btn btn-outline-secondary btn-sm" data-copy="${escapeHtml(ref)}">Copy</button>` : ""}
          </div>
        </div>

        <div class="order-detail-card mb-3">
          <div class="label">Customer</div>
          <div class="value">${escapeHtml(customer)} ${phone ? `<span class="text-muted ms-2">${escapeHtml(phone)}</span>` : ""}</div>
          ${servedBy ? `<div class="text-muted mt-1">Served by: ${escapeHtml(servedBy)}</div>` : ""}
        </div>

        <div class="order-detail-card mb-3 text-center">
          <div class="label">QR Code</div>
          ${qrUrl ? `<img src="${qrUrl}" alt="QR Code" style="max-width:220px; width:100%; height:auto; margin: .75rem auto; display:block;"/>` : ""}
          ${qrStatus ? `<div class="text-muted">${qrStatus}</div>` : ""}
          ${qrSource ? `<div class="text-muted small">Generated from activation code</div>` : ""}
        </div>

        <div class="order-detail-grid">
          <div class="order-detail-card">
            <div class="label">Activation Codes</div>
            <div class="value">${actCodes.length ? actCodes.map(c => `<div>${escapeHtml(c)}</div>`).join("") : "â€”"}</div>
          </div>
          <div class="order-detail-card">
            <div class="label">ICCID List</div>
            <div class="value">${iccids.length ? iccids.map(c => `<div>${escapeHtml(c)}</div>`).join("") : "â€”"}</div>
          </div>
        </div>

        <div class="order-actions">
          <button class="btn btn-outline-secondary" type="button">Refresh</button>
          <button class="btn btn-outline-secondary" type="button">Share</button>
          <button class="btn btn-success" type="button" data-whatsapp="${escapeHtml(whatsappMsg)}">Send via WhatsApp</button>
          <button class="btn btn-outline-secondary" type="button" data-print>Print</button>
        </div>
      `;
    };

    const refreshFilters = () => {
      if (agentEl) {
        const agents = Array.from(new Set(orders.map(o => o.agent_name).filter(Boolean)));
        agentEl.innerHTML = '<option value="">All agents</option>' + agents.map(a => `<option>${escapeHtml(a)}</option>`).join("");
      }
      if (companyEl) {
        const companies = Array.from(new Set(orders.map(o => o.company_name).filter(Boolean)));
        companyEl.innerHTML = '<option value="">All companies</option>' + companies.map(c => `<option>${escapeHtml(c)}</option>`).join("");
      }
    };

    const exportCsv = () => {
      const list = applyFilters();
      const rows = [
        ["Date","Customer","Company","Agent","Item","Country","Total IQD","Status","Reference"],
        ...list.map(o => [
          fmtDate(o.created_at),
          o.customer_name || "",
          o.company_name || "",
          o.agent_name || "",
          o.bundle_description || o.bundle_name || "eSIM",
          o.country_name || "",
          o.total_iqd || "",
          o.status || "",
          o.order_reference || "",
        ])
      ];
      const csv = rows.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `esim_orders_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    tabBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        tabBtns.forEach(b => b.classList.remove("is-active"));
        btn.classList.add("is-active");
        statusFilter = btn.dataset.status || "all";
        renderRows();
      });
    });

    searchEl?.addEventListener("input", renderRows);
    agentEl?.addEventListener("change", renderRows);
    companyEl?.addEventListener("change", renderRows);
    clearBtn?.addEventListener("click", () => {
      if (searchEl) searchEl.value = "";
      if (agentEl) agentEl.value = "";
      if (companyEl) companyEl.value = "";
      statusFilter = "all";
      tabBtns.forEach(b => b.classList.remove("is-active"));
      document.querySelector('.report-tab[data-status="all"]').classList.add("is-active");
      renderRows();
    });
    exportBtn?.addEventListener("click", exportCsv);

    rowsEl?.addEventListener("click", (e) => {
      const row = e.target.closest(".report-row[data-order-key]");
      if (!row || row.classList.contains("header")) return;
      const key = row.getAttribute("data-order-key") || "";
      const order = orderLookup.get(key);
      renderOrderDetails(order);
      if (orderModal) orderModal.show();
    });

    orderDetailsEl?.addEventListener("click", (e) => {
      const copyBtn = e.target.closest("[data-copy]");
      if (copyBtn) {
        copyText(copyBtn.getAttribute("data-copy") || "");
        return;
      }
      const printBtn = e.target.closest("[data-print]");
      if (printBtn) {
        window.print();
        return;
      }
      const waBtn = e.target.closest("[data-whatsapp]");
      if (waBtn) {
        const msg = waBtn.getAttribute("data-whatsapp") || "";
        const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
        window.open(url, "_blank", "noopener");
      }
    });

    fetch("/reports/esim/api/list")
      .then(r => r.json())
      .then(data => {
        orders = data.orders || [];
        refreshFilters();
        renderRows();
      })
      .catch(() => {
        if (rowsEl) rowsEl.innerHTML = '<div class="p-4 text-muted">Failed to load orders.</div>';
      });
  });
</script>
{% endblock %}
